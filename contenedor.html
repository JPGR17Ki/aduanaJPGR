<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD de Contenedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <h1>CRUD de Contenedores</h1>
        <form id="ing-contenedor">
            <div class="form-group">
                <label for="codigo">Código</label>
                <input type="text" class="form-control" id="codigo" placeholder="#001" required>
            </div>
            <button type="submit" class="btn btn-success mt-3">Agregar contenedor</button>
        </form>

        <div class="mt-5">
            <h2>Lista de Contenedores</h2>
            <ul id="contenedor-list" class="list-group"></ul>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const conexion = getFirestore(app);

        async function verificarCodigoExistente(codigo) {
            const c = query(collection(conexion, "contenedores"), where("codigo", "==", codigo));
            const querySnapshot = await getDocs(c);
            return !querySnapshot.empty;
        }

        const aduana = document.getElementById("ing-contenedor");
        aduana.addEventListener("submit", async (e) => {
            e.preventDefault();
            const codigo = aduana.codigo.value;

            const codigoExistente = await verificarCodigoExistente(codigo);
            if (codigoExistente) {
                alert("El código ya existe. Por favor, ingrese un código único.");
                return;
            }
            
            try {
                await addDoc(collection(conexion, "contenedores"), {
                    codigo: codigo
                });
                aduana.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        const contenedorList = document.getElementById("contenedor-list");

        function renderContenedor(doc) {
            const li = document.createElement("li");
            li.classList.add("list-group-item");
            li.setAttribute("data-id", doc.id);

            const codigo = document.createElement("span");
            codigo.textContent = doc.data().codigo;

            const editButton = document.createElement("button");
            editButton.textContent = "Editar";
            editButton.classList.add("btn", "btn-warning", "btn-sm", "ms-3");
            editButton.addEventListener("click", () => editContenedor(doc));

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Eliminar";
            deleteButton.classList.add("btn", "btn-danger", "btn-sm", "ms-2");
            deleteButton.addEventListener("click", () => deleteContenedor(doc.id));

            li.appendChild(codigo);
            li.appendChild(editButton);
            li.appendChild(deleteButton);

            contenedorList.appendChild(li);
        }

        function editContenedor(doc) {
            const newCodigo = prompt("Ingrese el nuevo código", doc.data().codigo);
            if (newCodigo && newCodigo !== doc.data().codigo) {
                const contenedorRef = doc(conexion, "contenedores", doc.id);
                updateDoc(contenedorRef, { codigo: newCodigo })
                    .then(() => console.log("Documento actualizado"))
                    .catch(error => console.error("Error updating document: ", error));
            }
        }

        function deleteContenedor(id) {
            const contenedorRef = doc(conexion, "contenedores", id);
            deleteDoc(contenedorRef)
                .then(() => console.log("Documento eliminado"))
                .catch(error => console.error("Error deleting document: ", error));
        }

        onSnapshot(collection(conexion, "contenedores"), (snapshot) => {
            contenedorList.innerHTML = "";
            snapshot.forEach(doc => renderContenedor(doc));
        });
    </script>
</body>
</html>
